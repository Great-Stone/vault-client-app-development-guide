# 🏗️ Vault 개발 서버 설정 가이드

## 📋 사전 준비사항

- vault 실행을 위한 바이너리 다운로드 및 압축 해제
  - https://www.vaultproject.io/downloads
- mysql 실행을 위한 docker 환경

아래 단계를 일괄 적용하는 예시 스크립트는 `setup-vault-for-my-vault-app.sh` 파일을 참고하세요.

### 1단계: Vault 개발 모드 실행

<https://developer.hashicorp.com/vault/install> 에서 vault를 다운로드 받아 압축을 해제 합니다.

다음의 명령어를 실행하여 vault를 실행합니다.
```bash
# Vault 개발 모드로 실행 (자동 unseal, 기본 정책 포함)
vault server -dev -dev-root-token-id="root"
```

**개발 모드 특징**:
- 자동으로 unseal됨
- 기본 root 토큰: `root`
- 데이터는 메모리에만 저장 (재시작 시 초기화)

### 2단계: Vault 환경변수 설정

Linux/Unix/MacOS:
```bash
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_TOKEN='root'
```

Windows:
```batch
set VAULT_ADDR=http://127.0.0.1:8200
set VAULT_TOKEN=root
```

### 3단계: AppRole 인증 활성화

다른 커맨드 창에서 다음의 명령어를 실행하여 AppRole 인증을 활성화 합니다.

```bash
# AppRole 인증 방법 활성화
vault auth enable approle
```


#### 🏗️ **Entity 생성 및 AppRole 연결**

Entity는 앱에 부여할 고유 식별자로 사용됩니다. 이 식별자는 AppRole과 연결되며, Policy, Secret 경로에 사용됩니다.

```bash
# Entity 생성 (앱별 고유 식별자)
vault write identity/entity name="my-vault-app" policies="myapp-templated-policy"

# Entity ID 정보 확인
vault read -field=id /identity/entity/name/my-vault-app

# AppRole Accessor ID 정보 확인
vault read -field=accessor sys/auth/approle

# Role ID 조회
vault read auth/approle/role/my-vault-app/role-id

# Entity Alias 생성
vault write identity/entity-alias name="<role_id>" canonical_id="<entity_id>" mount_accessor="<approle_accessor_id>"

# AppRole을 Entity와 연결
vault write auth/approle/role/my-vault-app \
  secret_id_ttl=1h \
  token_ttl=0 \
  token_max_ttl=0 \
  period=1m \
  orphan=true

# Secret ID 생성
vault write -f auth/approle/role/my-vault-app/secret-id
```

- secret_id_ttl은 Secret ID의 유효 기간을 설정합니다. 테스트를 위해 1시간으로 설정했습니다. 일반적으로 이 유지 시간은 앱 부팅 시간 정도로 설정합니다.
- period는 토큰 갱신 주기를 설정합니다. 테스트를 위해 1분으로 설정했습니다.

### 4단계: Policy Templating을 활용한 고급 정책 구성

#### 🔐 **Entity 기반 정책 생성**

[Vault ACL Policy Templating](https://developer.hashicorp.com/vault/tutorials/policies/policy-templating)을 사용하여 앱별 고유 엔티티를 지정하고, 해당 이름으로의 KV 경로에 대해 허용하는 정책을 구성합니다.

```bash
# Entity 기반 템플릿 정책 생성
vault policy write myapp-templated-policy - <<EOF
# 앱별 전용 시크릿 경로 (identity.entity.name 기반)
path "{{identity.entity.name}}-kv/data/*" {
  capabilities = ["read", "list"]
}

path "{{identity.entity.name}}-database/creds/*" {
  capabilities = ["read", "list"]
}

path "{{identity.entity.name}}-database/static-creds/*" {
  capabilities = ["read", "list"]
}

# 토큰 갱신 권한
path "auth/token/renew-self" {
  capabilities = ["update"]
}

# 토큰 조회 권한
path "auth/token/lookup-self" {
  capabilities = ["read"]
}
EOF
```

### 5단계: KV 시크릿 엔진 활성화

```bash
# KV v2 시크릿 엔진 활성화
vault secrets enable -path=my-vault-app-kv kv-v2

# 예시 시크릿 데이터 생성
vault kv put my-vault-app-kv/sample \
  sample_secret="my-secret-value-123" \
  database_url="postgresql://user:pass@localhost:5432/mydb"
```

### 6단계: Database 시크릿 엔진 활성화

[Vault Database Secrets Engine](https://developer.hashicorp.com/vault/docs/secrets/databases)을 사용하여 Database 시크릿 엔진을 활성화 합니다. 여기서는 mysql을 docker로 실행하여 사용합니다.

```bash
# MySQL 컨테이너 실행 (기존 사용중인 mysql이 있다면 해당 mysql을 사용하세요.)
docker run --name my-vault-app-mysql -e MYSQL_ROOT_PASSWORD=password -d -p 3306:3306 mysql:9
```

```bash
# Password만 교체할 Static User 생성
mysql -u root -ppassword -h 127.0.0.1 -P 3306 --protocol=TCP -e "CREATE USER 'my-vault-app-static'@'%' IDENTIFIED BY 'password'; GRANT ALL PRIVILEGES ON *.* TO 'my-vault-app-static'@'%';"
```

```bash
# Database 시크릿 엔진 활성화
vault secrets enable -path=my-vault-app-database database

# Database 시크릿 엔진 설정
vault write my-vault-app-database/config/mysql-demo \
  plugin_name=mysql-database-plugin \
  connection_url="{{username}}:{{password}}@tcp(localhost:3306)/" \
  allowed_roles="*" \
  username="root" \
  password="password"

# Dynamic Role 생성
vault write my-vault-app-database/roles/db-demo-dynamic \
  db_name=mysql-demo \
  creation_statements="CREATE USER '{{username}}'@'%' IDENTIFIED BY '{{password}}'; GRANT ALL PRIVILEGES ON *.* TO '{{username}}'@'%';" \
  default_ttl="1h" \
  max_ttl="24h"

# Dynamic Role 테스트 (유효 기간, Username, Password 확인)
vault read my-vault-app-database/creds/db-demo-dynamic

# Static Role 생성 (Password 교체 주기 설정)
vault write my-vault-app-database/static-roles/db-demo-static \
  db_name=mysql-demo \
  username=my-vault-app-static \
  rotation_schedule="0 * * * *"

# Static Role 테스트 (현재 Password 및 남은 시간 확인)
vault read my-vault-app-database/static-creds/db-demo-static
```

**Policy Templating의 장점**:
- **동적 경로**: `{{identity.entity.name}}` 패턴으로 앱별 고유 경로 자동 생성
- **보안 격리**: 각 앱은 자신의 시크릿에만 접근 가능
- **운영 효율성**: 새로운 앱 추가 시 정책 수정 불필요

---

## 🔍 설정 검증

### 1. Vault 상태 확인

```bash
# Vault 서버 상태 확인
vault status

# 인증 방법 확인
vault auth list

# 시크릿 엔진 확인
vault secrets list
```

### 2. 정책 확인

```bash
# 생성된 정책 확인
vault policy list

# 정책 내용 확인
vault policy read myapp-templated-policy
```

### 3. Entity 및 AppRole 확인

```bash
# Entity 목록 확인
vault list identity/entity

# AppRole 설정 확인
vault read auth/approle/role/my-vault-app
```

### 4. 시크릿 접근 테스트

```bash
# Role ID 조회
vault read auth/approle/role/my-vault-app/role-id

# Secret ID 생성
vault write -f auth/approle/role/my-vault-app/secret-id

# AppRole로 로그인 테스트
vault write auth/approle/login role_id="<role_id>" secret_id="<secret_id>"

# 시크릿 조회 테스트
vault kv get my-vault-app-kv/sample
```

---

## ⚠️ 주의사항

### 개발 환경 전용
- 이 설정은 **개발 환경에서만** 사용하세요
- 운영 환경에서는 적절한 보안 설정이 필요합니다

### 데이터 지속성
- 개발 모드는 메모리 기반이므로 서버 재시작 시 모든 데이터가 사라집니다
- 영구 저장이 필요한 경우 파일 기반 스토리지 백엔드를 사용하세요

### 보안 고려사항
- `root` 토큰은 절대 운영 환경에서 사용하지 마세요
- 적절한 토큰 TTL 설정을 유지하세요
- 정기적인 보안 감사를 수행하세요
