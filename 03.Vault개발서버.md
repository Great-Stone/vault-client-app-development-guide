# ğŸ—ï¸ Vault ê°œë°œ ì„œë²„ ì„¤ì • ê°€ì´ë“œ

## ğŸ“‹ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- vault ì‹¤í–‰ì„ ìœ„í•œ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
  - https://www.vaultproject.io/downloads
- mysql ì‹¤í–‰ì„ ìœ„í•œ docker í™˜ê²½

ì•„ë˜ ë‹¨ê³„ë¥¼ ì¼ê´„ ì ìš©í•˜ëŠ” ì˜ˆì‹œ ìŠ¤í¬ë¦½íŠ¸ëŠ” `setup-vault-for-my-vault-app.sh` íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.

### 1ë‹¨ê³„: Vault ê°œë°œ ëª¨ë“œ ì‹¤í–‰

<https://developer.hashicorp.com/vault/install> ì—ì„œ vaultë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ ì••ì¶•ì„ í•´ì œ í•©ë‹ˆë‹¤.

ë‹¤ìŒì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ vaultë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
```bash
# Vault ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰ (ìë™ unseal, ê¸°ë³¸ ì •ì±… í¬í•¨)
vault server -dev -dev-root-token-id="root"
```

**ê°œë°œ ëª¨ë“œ íŠ¹ì§•**:
- ìë™ìœ¼ë¡œ unsealë¨
- ê¸°ë³¸ root í† í°: `root`
- ë°ì´í„°ëŠ” ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥ (ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”)

### 2ë‹¨ê³„: Vault í™˜ê²½ë³€ìˆ˜ ì„¤ì •

Linux/Unix/MacOS:
```bash
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_TOKEN='root'
```

Windows:
```batch
set VAULT_ADDR=http://127.0.0.1:8200
set VAULT_TOKEN=root
```

### 3ë‹¨ê³„: AppRole ì¸ì¦ í™œì„±í™”

ë‹¤ë¥¸ ì»¤ë§¨ë“œ ì°½ì—ì„œ ë‹¤ìŒì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ AppRole ì¸ì¦ì„ í™œì„±í™” í•©ë‹ˆë‹¤.

```bash
# AppRole ì¸ì¦ ë°©ë²• í™œì„±í™”
vault auth enable approle
```


#### ğŸ—ï¸ **Entity ìƒì„± ë° AppRole ì—°ê²°**

EntityëŠ” ì•±ì— ë¶€ì—¬í•  ê³ ìœ  ì‹ë³„ìë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ì‹ë³„ìëŠ” AppRoleê³¼ ì—°ê²°ë˜ë©°, Policy, Secret ê²½ë¡œì— ì‚¬ìš©ë©ë‹ˆë‹¤.

```bash
# Entity ìƒì„± (ì•±ë³„ ê³ ìœ  ì‹ë³„ì)
vault write identity/entity name="my-vault-app" policies="myapp-templated-policy"

# Entity ID ì •ë³´ í™•ì¸
vault read -field=id /identity/entity/name/my-vault-app

# AppRole Accessor ID ì •ë³´ í™•ì¸
vault read -field=accessor sys/auth/approle

# Role ID ì¡°íšŒ
vault read auth/approle/role/my-vault-app/role-id

# Entity Alias ìƒì„±
vault write identity/entity-alias name="<role_id>" canonical_id="<entity_id>" mount_accessor="<approle_accessor_id>"

# AppRoleì„ Entityì™€ ì—°ê²°
vault write auth/approle/role/my-vault-app \
  secret_id_ttl=1h \
  token_ttl=0 \
  token_max_ttl=0 \
  period=1m \
  orphan=true

# Secret ID ìƒì„±
vault write -f auth/approle/role/my-vault-app/secret-id
```

- secret_id_ttlì€ Secret IDì˜ ìœ íš¨ ê¸°ê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 1ì‹œê°„ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ìœ ì§€ ì‹œê°„ì€ ì•± ë¶€íŒ… ì‹œê°„ ì •ë„ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- periodëŠ” í† í° ê°±ì‹  ì£¼ê¸°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 1ë¶„ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

### 4ë‹¨ê³„: Policy Templatingì„ í™œìš©í•œ ê³ ê¸‰ ì •ì±… êµ¬ì„±

#### ğŸ” **Entity ê¸°ë°˜ ì •ì±… ìƒì„±**

[Vault ACL Policy Templating](https://developer.hashicorp.com/vault/tutorials/policies/policy-templating)ì„ ì‚¬ìš©í•˜ì—¬ ì•±ë³„ ê³ ìœ  ì—”í‹°í‹°ë¥¼ ì§€ì •í•˜ê³ , í•´ë‹¹ ì´ë¦„ìœ¼ë¡œì˜ KV ê²½ë¡œì— ëŒ€í•´ í—ˆìš©í•˜ëŠ” ì •ì±…ì„ êµ¬ì„±í•©ë‹ˆë‹¤.

```bash
# Entity ê¸°ë°˜ í…œí”Œë¦¿ ì •ì±… ìƒì„±
vault policy write myapp-templated-policy - <<EOF
# ì•±ë³„ ì „ìš© ì‹œí¬ë¦¿ ê²½ë¡œ (identity.entity.name ê¸°ë°˜)
path "{{identity.entity.name}}-kv/data/*" {
  capabilities = ["read", "list"]
}

path "{{identity.entity.name}}-database/creds/*" {
  capabilities = ["read", "list"]
}

path "{{identity.entity.name}}-database/static-creds/*" {
  capabilities = ["read", "list"]
}

# í† í° ê°±ì‹  ê¶Œí•œ
path "auth/token/renew-self" {
  capabilities = ["update"]
}

# í† í° ì¡°íšŒ ê¶Œí•œ
path "auth/token/lookup-self" {
  capabilities = ["read"]
}
EOF
```

### 5ë‹¨ê³„: KV ì‹œí¬ë¦¿ ì—”ì§„ í™œì„±í™”

```bash
# KV v2 ì‹œí¬ë¦¿ ì—”ì§„ í™œì„±í™”
vault secrets enable -path=my-vault-app-kv kv-v2

# ì˜ˆì‹œ ì‹œí¬ë¦¿ ë°ì´í„° ìƒì„±
vault kv put my-vault-app-kv/sample \
  sample_secret="my-secret-value-123" \
  database_url="postgresql://user:pass@localhost:5432/mydb"
```

### 6ë‹¨ê³„: Database ì‹œí¬ë¦¿ ì—”ì§„ í™œì„±í™”

[Vault Database Secrets Engine](https://developer.hashicorp.com/vault/docs/secrets/databases)ì„ ì‚¬ìš©í•˜ì—¬ Database ì‹œí¬ë¦¿ ì—”ì§„ì„ í™œì„±í™” í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” mysqlì„ dockerë¡œ ì‹¤í–‰í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
# MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ê¸°ì¡´ ì‚¬ìš©ì¤‘ì¸ mysqlì´ ìˆë‹¤ë©´ í•´ë‹¹ mysqlì„ ì‚¬ìš©í•˜ì„¸ìš”.)
docker run --name my-vault-app-mysql -e MYSQL_ROOT_PASSWORD=password -d -p 3306:3306 mysql:9
```

```bash
# Passwordë§Œ êµì²´í•  Static User ìƒì„±
mysql -u root -ppassword -h 127.0.0.1 -P 3306 --protocol=TCP -e "CREATE USER 'my-vault-app-static'@'%' IDENTIFIED BY 'password'; GRANT ALL PRIVILEGES ON *.* TO 'my-vault-app-static'@'%';"
```

```bash
# Database ì‹œí¬ë¦¿ ì—”ì§„ í™œì„±í™”
vault secrets enable -path=my-vault-app-database database

# Database ì‹œí¬ë¦¿ ì—”ì§„ ì„¤ì •
vault write my-vault-app-database/config/mysql-demo \
  plugin_name=mysql-database-plugin \
  connection_url="{{username}}:{{password}}@tcp(localhost:3306)/" \
  allowed_roles="*" \
  username="root" \
  password="password"

# Dynamic Role ìƒì„±
vault write my-vault-app-database/roles/db-demo-dynamic \
  db_name=mysql-demo \
  creation_statements="CREATE USER '{{username}}'@'%' IDENTIFIED BY '{{password}}'; GRANT ALL PRIVILEGES ON *.* TO '{{username}}'@'%';" \
  default_ttl="1h" \
  max_ttl="24h"

# Dynamic Role í…ŒìŠ¤íŠ¸ (ìœ íš¨ ê¸°ê°„, Username, Password í™•ì¸)
vault read my-vault-app-database/creds/db-demo-dynamic

# Static Role ìƒì„± (Password êµì²´ ì£¼ê¸° ì„¤ì •)
vault write my-vault-app-database/static-roles/db-demo-static \
  db_name=mysql-demo \
  username=my-vault-app-static \
  rotation_schedule="0 * * * *"

# Static Role í…ŒìŠ¤íŠ¸ (í˜„ì¬ Password ë° ë‚¨ì€ ì‹œê°„ í™•ì¸)
vault read my-vault-app-database/static-creds/db-demo-static
```

**Policy Templatingì˜ ì¥ì **:
- **ë™ì  ê²½ë¡œ**: `{{identity.entity.name}}` íŒ¨í„´ìœ¼ë¡œ ì•±ë³„ ê³ ìœ  ê²½ë¡œ ìë™ ìƒì„±
- **ë³´ì•ˆ ê²©ë¦¬**: ê° ì•±ì€ ìì‹ ì˜ ì‹œí¬ë¦¿ì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥
- **ìš´ì˜ íš¨ìœ¨ì„±**: ìƒˆë¡œìš´ ì•± ì¶”ê°€ ì‹œ ì •ì±… ìˆ˜ì • ë¶ˆí•„ìš”

---

## ğŸ” ì„¤ì • ê²€ì¦

### 1. Vault ìƒíƒœ í™•ì¸

```bash
# Vault ì„œë²„ ìƒíƒœ í™•ì¸
vault status

# ì¸ì¦ ë°©ë²• í™•ì¸
vault auth list

# ì‹œí¬ë¦¿ ì—”ì§„ í™•ì¸
vault secrets list
```

### 2. ì •ì±… í™•ì¸

```bash
# ìƒì„±ëœ ì •ì±… í™•ì¸
vault policy list

# ì •ì±… ë‚´ìš© í™•ì¸
vault policy read myapp-templated-policy
```

### 3. Entity ë° AppRole í™•ì¸

```bash
# Entity ëª©ë¡ í™•ì¸
vault list identity/entity

# AppRole ì„¤ì • í™•ì¸
vault read auth/approle/role/my-vault-app
```

### 4. ì‹œí¬ë¦¿ ì ‘ê·¼ í…ŒìŠ¤íŠ¸

```bash
# Role ID ì¡°íšŒ
vault read auth/approle/role/my-vault-app/role-id

# Secret ID ìƒì„±
vault write -f auth/approle/role/my-vault-app/secret-id

# AppRoleë¡œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
vault write auth/approle/login role_id="<role_id>" secret_id="<secret_id>"

# ì‹œí¬ë¦¿ ì¡°íšŒ í…ŒìŠ¤íŠ¸
vault kv get my-vault-app-kv/sample
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ê°œë°œ í™˜ê²½ ì „ìš©
- ì´ ì„¤ì •ì€ **ê°œë°œ í™˜ê²½ì—ì„œë§Œ** ì‚¬ìš©í•˜ì„¸ìš”
- ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì ì ˆí•œ ë³´ì•ˆ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤

### ë°ì´í„° ì§€ì†ì„±
- ê°œë°œ ëª¨ë“œëŠ” ë©”ëª¨ë¦¬ ê¸°ë°˜ì´ë¯€ë¡œ ì„œë²„ ì¬ì‹œì‘ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤
- ì˜êµ¬ ì €ì¥ì´ í•„ìš”í•œ ê²½ìš° íŒŒì¼ ê¸°ë°˜ ìŠ¤í† ë¦¬ì§€ ë°±ì—”ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”

### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- `root` í† í°ì€ ì ˆëŒ€ ìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- ì ì ˆí•œ í† í° TTL ì„¤ì •ì„ ìœ ì§€í•˜ì„¸ìš”
- ì •ê¸°ì ì¸ ë³´ì•ˆ ê°ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”
